<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YouTube Trending Analytics â€” Ultra Modern</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP for smooth animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="sha512-H9nqk2qkq6s3g3f3mZ8x2nTqk1Vjz/2iFqz+9rH0k9uOi8iOZ9q6l9b2mFQjwGq4q8b2J2k3Z7n5oE2w9r8aQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Chart.js Gauge plugin (simple implementation using doughnut) - no extra plugin needed -->
  <!-- FileSaver for exports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-bGQmCj3G6r1sB9xQ5GQZqv1w2m6Xq1yqW5z1K0zq1W5y1z5H7Z6b8Q2r6xv9w0p2" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Material-like color CSS variables -->
 <style>
:root{
  /* Google / Material inspired palette (teal/cyan/indigo/purple accents) */
  --bg-900: #0f1724;
  --surface: rgba(255,255,255,0.04);
  --card: rgba(255,255,255,0.03);
  --muted: #94a3b8;
  --text: #e6eef8;
  --accent-1: #0ea5a4;
  --accent-2: #06b6d4;
  --accent-3: #7c3aed;
  --accent-4: #6366f1;
  --success: #10b981;
  --danger: #ef4444;
  --glass: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.02);
  --card-border: rgba(255,255,255,0.06);
  --blur: 10px;
  --radius: 14px;
}

/* ================= BASE UI ================= */
body{
  background: linear-gradient(180deg,var(--bg-900), #03040a 120%);
  color:var(--text);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI",
  Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.glass{
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.02),
    rgba(255,255,255,0.015)
  );
  border: 1px solid var(--card-border);
  backdrop-filter: blur(var(--blur));
  border-radius: var(--radius);
}

.glass-soft{
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.025),
    rgba(255,255,255,0.01)
  );
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.02);
  backdrop-filter: blur(6px);
}

.accent-glow{
  box-shadow:
    0 8px 40px -10px rgba(6,182,212,0.18),
    inset 0 1px 0 rgba(255,255,255,0.02);
}

.muted{ color: var(--muted); }
.small{ font-size: 0.85rem; }

.kbd{
  background: rgba(255,255,255,0.03);
  padding:4px 8px;
  border-radius:6px;
  font-weight:600;
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.02);
}

/* ================= MORPH EFFECT ================= */
.morph{
  transition:
    transform .35s cubic-bezier(.22,.9,.2,1),
    box-shadow .35s;
  will-change: transform;
}
.morph:hover{
  transform: translateY(-8px) scale(1.01);
  box-shadow: 0 12px 40px rgba(7,12,20,0.5);
}

/* ================= COUNTERS ================= */
.counter{
  font-variant-numeric: tabular-nums;
  font-weight:700;
}

/* ================= TABLE ================= */
.table-card table td,
.table-card table th{
  border-bottom: 1px dashed rgba(255,255,255,0.03);
  padding:12px 8px;
}

/* ================= CHIP ================= */
.chip{
  background: rgba(255,255,255,0.03);
  padding:6px 10px;
  border-radius:999px;
  font-size:0.85rem;
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.02);
}

/* ================= SLIDER ================= */
input[type="range"]{
  -webkit-appearance:none;
  height:8px;
  background: linear-gradient(90deg,var(--accent-2), var(--accent-4));
  border-radius:999px;
  outline:none;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:20px;
  height:20px;
  border-radius:50%;
  background: linear-gradient(180deg,#fff, #e6eff8);
  box-shadow: 0 4px 12px rgba(2,6,23,0.6);
  border: 3px solid rgba(3,7,18,0.4);
  cursor:pointer;
}

/* ================= PROGRESS ================= */
.progress-track{
  background: rgba(255,255,255,0.03);
  height:14px;
  border-radius:999px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background: linear-gradient(90deg,var(--accent-2),var(--accent-3));
  border-radius:999px;
  transition: width 1.2s cubic-bezier(.2,.9,.3,1);
}

/* ================= MODAL ================= */
.modal-backdrop{
  position: fixed;
  inset:0;
  background: rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:60;
}
.modal-backdrop.show{ display:flex; }

/* ================= SKELETON ================= */
.skeleton{
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0.02) 0%,
    rgba(255,255,255,0.04) 50%,
    rgba(255,255,255,0.02) 100%
  );
  background-size:200% 100%;
  animation: shimmer 1.6s linear infinite;
  border-radius:8px;
}
@keyframes shimmer{
  from{ background-position:200% 0 }
  to{ background-position:-200% 0 }
}

/* ================================================= */
/* ================= THEME ENGINE ================== */
/* ================================================= */

:root[data-theme="material"]{
  --bg-900:#0f1724;
  --text:#e6eef8;
  --accent-1:#0ea5a4;
  --accent-2:#06b6d4;
  --accent-3:#7c3aed;
  --accent-4:#6366f1;
}

:root[data-theme="neon"]{
  --bg-900:#020617;
  --text:#ecfeff;
  --accent-1:#22d3ee;
  --accent-2:#38bdf8;
  --accent-3:#a78bfa;
  --accent-4:#f0abfc;
}

:root[data-theme="slate"]{
  --bg-900:#020617;
  --text:#e5e7eb;
  --accent-1:#64748b;
  --accent-2:#94a3b8;
  --accent-3:#475569;
  --accent-4:#334155;
}

:root[data-theme="light"]{
  --bg-900:#f8fafc;
  --text:#020617;
  --accent-1:#0ea5e9;
  --accent-2:#0284c7;
  --accent-3:#6366f1;
  --accent-4:#7c3aed;
}

:root[data-theme="oled"]{
  --bg-900:#000000;
  --text:#ffffff;
  --accent-1:#22d3ee;
  --accent-2:#06b6d4;
  --accent-3:#a855f7;
  --accent-4:#6366f1;
}

/* ================= SMOOTH TRANSITION ================= */
*{
  transition:
    background-color .35s ease,
    color .35s ease,
    border-color .35s ease;
}
</style>


  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body class="min-h-screen antialiased">

<!-- NAVBAR -->
<header class="sticky top-0 z-40 bg-gradient-to-b from-black/40 to-transparent border-b border-white/4">
  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div class="p-2 rounded-lg glass soft-shadow" style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2));">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" fill="white" opacity="0.06"/><path d="M7 10.5L11 8l4 2.5-4 2.5-4-2.5z" fill="white"/></svg>
      </div>
      <div>
        <h1 class="text-lg font-semibold tracking-wide">YouTube Trending Analytics</h1>
        <p class="small muted">Realtime Â· Model Inference Â· Studio Insights</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <!-- Model status -->
      <div class="flex items-center gap-2 px-3 py-1 rounded-full border border-white/6 glass-soft">
        <span class="h-2 w-2 rounded-full bg-emerald-400/90 block"></span>
        <span class="small muted">Model Active</span>
      </div>

      <!-- Theme toggle -->
      <button id="themeToggle" class="kbd">Theme</button>

      <!-- Quick actions -->
      <div class="relative">
        <button id="exportBtn" class="kbd">Export CSV</button>
      </div>
    </div>
  </div>
</header>

<!-- MAIN LAYOUT -->
<main class="max-w-7xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-4 gap-6">

  <!-- LEFT SIDEBAR (controls + prediction) -->
  <aside class="lg:col-span-1 space-y-6">
    <!-- Filters card -->
    <div class="glass p-5 morph">
      <h2 class="font-semibold">Filters</h2>
      <form method="get" id="filtersForm" class="mt-4 space-y-3">
        <div>
          <label class="small muted">Region</label>
          <select name="region" class="w-full mt-2 bg-transparent border border-white/6 px-3 py-2 rounded-lg">
            <option value="">All Regions</option>
            {% for r in regions %}
              <option value="{{ r }}" {% if r == selected_region %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="small muted">Category</label>
          <select name="category" class="w-full mt-2 bg-transparent border border-white/6 px-3 py-2 rounded-lg">
            <option value="">All Categories</option>
            {% for id,name in categories.items() %}
              <option value="{{ id }}" {% if id|string==selected_category %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-gradient-to-r from-[var(--accent-1)] to-[var(--accent-2)] text-black font-semibold py-2 rounded-lg">Apply</button>
          <button type="button" id="resetFilters" class="flex-1 border border-white/6 py-2 rounded-lg muted">Reset</button>
        </div>
      </form>
    </div>

    <!-- Predict Card -->
    <div class="glass p-5 morph">
      <h2 class="font-semibold">Predict New Video</h2>
      <p class="small muted">Real-time inference â€” enter metrics</p>

      <form method="post" action="/predict_ctr" id="predictForm" class="mt-4 space-y-3">
        <input type="hidden" name="region" value="{{ selected_region }}">
        <input type="hidden" name="category" value="{{ selected_category }}">

        <label class="small muted">Title length</label>
        <input class="w-full bg-transparent border border-white/6 rounded-lg px-3 py-2" name="title_length" type="number" min="1" required>

        <label class="small muted">Publish hour (0-23)</label>
        <input class="w-full bg-transparent border border-white/6 rounded-lg px-3 py-2" name="publish_hour" type="number" min="0" max="23" required>

        <label class="small muted">Publish day (0=Mon)</label>
        <input class="w-full bg-transparent border border-white/6 rounded-lg px-3 py-2" name="publish_day" type="number" min="0" max="6" required>

        <label class="small muted">Expected Views</label>
        <input class="w-full bg-transparent border border-white/6 rounded-lg px-3 py-2" name="views" type="number" min="0" required>

        <div class="flex gap-2 items-center">
          <button type="submit" class="flex-1 bg-gradient-to-r from-[var(--accent-4)] to-[var(--accent-3)] text-black py-2 rounded-lg font-semibold">Predict</button>
          <button type="button" id="demoBtn" class="flex-none px-3 py-2 border border-white/6 rounded-lg muted">Demo</button>
        </div>
      </form>

      <div id="predictionResult" class="mt-4 p-3 glass-soft rounded-lg hidden">
        <div class="flex items-center justify-between">
          <div>
            <div class="small muted">Predicted CTR</div>
            <div class="text-2xl counter" id="predCTR">--%</div>
            <div class="small muted">Confidence <span id="predConf">--%</span></div>
          </div>
          <div style="width:120px;">
            <div class="progress-track" aria-hidden>
              <div id="predProgress" class="progress-fill" style="width:0%"></div>
            </div>
          </div>
        </div>
        <div class="mt-3 small muted" id="predExplain">Explainability summary will appear here.</div>
      </div>
    </div>

    <!-- Quick stats compact -->
    <div class="glass p-4 morph">
      <h3 class="font-medium">Quick Summary</h3>
      <div class="mt-3 grid grid-cols-2 gap-3">
        <div class="p-3 rounded-lg bg-gradient-to-br from-[rgba(6,182,212,0.04)] to-transparent">
          <div class="small muted">Total Videos</div>
          <div class="counter text-xl font-bold">{{ top_videos|length }}</div>
        </div>
        <div class="p-3 rounded-lg bg-gradient-to-br from-[rgba(124,58,237,0.04)] to-transparent">
          <div class="small muted">Avg Engagement</div>
          <div class="counter text-xl font-bold">{{ "%.3f"|format(competitors[0].avg_engagement if competitors|length>0 else 0) }}</div>
        </div>
      </div>
    </div>

    <!-- Explainability / Tips -->
    <div class="glass p-4 morph">
      <h3 class="font-medium">Prediction Tips</h3>
      <ul class="mt-2 small muted space-y-2">
        <li>â€¢ Short, clear titles improve CTR.</li>
        <li>â€¢ Publishes during peak hours increase immediate view velocity.</li>
        <li>â€¢ Tags aligned with trending topics help discoverability.</li>
      </ul>
    </div>
  </aside>

  <!-- MAIN CONTENT (charts, tables) -->
  <section class="lg:col-span-3 space-y-6">

    <!-- Top KPIs row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="glass p-5 morph flex items-center justify-between">
        <div>
          <div class="small muted">CTR Prediction</div>
          <div class="text-3xl font-bold counter">{{ ctr_result if ctr_result else "--" }}%</div>
        </div>
        <div class="text-right">
          <div class="small muted">Confidence</div>
          <div class="text-2xl font-bold">{{ confidence if confidence else "--" }}%</div>
        </div>
      </div>

      <div class="glass p-5 morph">
        <div class="small muted">Trending</div>
        <div class="text-xl font-bold">{{ confidence_level if confidence_level else "N/A" }}</div>
        <div class="mt-3 small muted">Model status: <span class="chip">Live</span></div>
      </div>

      <div class="glass p-5 morph">
        <div class="small muted">Channel Insights</div>
        <div class="text-xl font-bold">{{ competitors|length }}</div>
        <div class="mt-3 small muted">Top competitor: <strong>{{ competitors[0].channel_title if competitors|length>0 else 'N/A' }}</strong></div>
      </div>
    </div>

    <!-- Big charts area -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Views vs likes / views-per-day -->
      <div class="glass p-5 morph">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Views vs Engagement</h3>
          <div class="small muted">Last 10 top videos</div>
        </div>
        <div class="mt-4">
          <canvas id="viewsEngagement" height="180"></canvas>
        </div>
      </div>

      <!-- Region / category breakdown + gauge -->
      <div class="glass p-5 morph">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Trending Probability Gauge</h3>
          <div class="small muted">Realtime confidence</div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <canvas id="gaugeChart" height="180"></canvas>
          </div>
          <div>
            <div class="small muted">Breakdown</div>
            <div class="mt-3 space-y-2">
              <div class="flex items-center justify-between">
                <div class="small muted">Views/Day (Top)</div>
                <div class="font-semibold">{{ "%.0f"|format(top_videos[0].views_per_day if top_videos|length>0 else 0) }}</div>
              </div>
              <div class="flex items-center justify-between">
                <div class="small muted">Avg Engagement</div>
                <div class="font-semibold">{{ "%.3f"|format(competitors[0].avg_engagement if competitors|length>0 else 0) }}</div>
              </div>

              <div class="pt-4">
                <div class="small muted mb-2">Predicted Trend Level</div>
                <div class="progress-track"><div id="gaugeProgress" class="progress-fill" style="width: {{ confidence if confidence else 0 }}%"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive mini controls -->
    <div class="glass p-4 morph flex flex-col md:flex-row gap-3 items-center">
      <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
        <div class="p-3 rounded-lg bg-gradient-to-r from-[rgba(6,182,212,0.03)] to-transparent">
          <div class="small muted">Filter by Views</div>
          <input id="viewsSlider" type="range" min="0" max="1000000" step="1000" value="100000" />
          <div class="small muted mt-1">Less than <span id="viewsVal">100000</span> views</div>
        </div>

        <div class="p-3 rounded-lg bg-gradient-to-r from-[rgba(99,102,241,0.03)] to-transparent">
          <div class="small muted">Filter by Engagement</div>
          <input id="engSlider" type="range" min="0" max="1" step="0.001" value="0.05" />
          <div class="small muted mt-1">More than <span id="engVal">0.050</span> engagement</div>
        </div>

        <div class="p-3 rounded-lg">
          <div class="small muted">Quick actions</div>
          <div class="mt-2 flex gap-2">
            <button id="refreshBtn" class="kbd">Refresh</button>
            <button id="downloadReport" class="kbd">Download</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Top videos table -->
    <div class="glass table-card p-4 morph">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Top Trending Videos</h3>
        <div class="small muted">Showing top {{ top_videos|length }} <span class="muted">â€¢</span> <button id="toggleCompact" class="kbd">Compact</button></div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="text-slate-400 small">
            <tr>
              <th class="text-left">#</th>
              <th class="text-left">Title</th>
              <th>Views</th>
              <th>Views/Day</th>
              <th>Likes</th>
              <th>Engagement</th>
            </tr>
          </thead>
          <tbody>
            {% for v in top_videos %}
              <tr class="hover:bg-white/2">
                <td class="py-2 px-2">{{ loop.index }}</td>
                <td class="py-2">{{ v.title }}</td>
                <td class="py-2 text-center">{{ v.views }}</td>
                <td class="py-2 text-center">{{ "%.2f"|format(v.views_per_day) }}</td>
                <td class="py-2 text-center">{{ v.likes }}</td>
                <td class="py-2 text-center">{{ "%.4f"|format(v.engagement_rate if 'engagement_rate' in v else 0) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Competitors & tags -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="glass p-4 morph">
        <h4 class="font-semibold">Top Competitors</h4>
        <ul class="mt-3 space-y-2 small muted">
          {% for c in competitors %}
            <li class="flex items-center justify-between"><span>{{ c.channel_title }}</span> <strong>{{ "%.0f"|format(c.avg_views) }}</strong></li>
          {% endfor %}
        </ul>
      </div>

      <div class="glass p-4 morph">
        <h4 class="font-semibold">Popular Tags</h4>
        <div class="mt-3 flex flex-wrap gap-2">
          {% for t in popular_tags %}
            <span class="chip">#{{ t.tag }}</span>
          {% endfor %}
        </div>
      </div>

      <div class="glass p-4 morph">
        <h4 class="font-semibold">Explainability</h4>
        <div class="small muted mt-2" id="explainBox">
          {% if explanations %}
            <ul class="list-disc ml-4">
              {% for e in explanations %}
                <li>{{ e }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No explanations available. Use the predictor to generate explanations.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </section>
</main>

<!-- FOOTER -->
<footer class="max-w-7xl mx-auto px-6 py-6 text-center muted small">
  Â© 2026 â€” YouTube Trending Analytics Â· Built with Flask Â· Design inspired by Material & modern SaaS
</footer>

<!-- MODAL (example) -->
<div id="modal" class="modal-backdrop">
  <div class="glass p-6 w-11/12 md:w-2/3 lg:w-1/2">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold">Download Report</h3>
      <button id="closeModal" class="kbd">Close</button>
    </div>
    <div class="mt-4 small muted">
      Choose format:
      <div class="mt-3 flex gap-2">
        <button id="downloadCSV" class="kbd">CSV</button>
        <button id="downloadPNG" class="kbd">PNG (chart snapshot)</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS: large interactive JS -->
<script>
/* ---------- Utility & data bridge ---------- */
/* Data provided by Flask/Jinja context (safe tojson usage) */
const TOP_VIDEOS = {{ top_videos | tojson | safe }};
const COMPETITORS = {{ competitors | tojson | safe }};
const POPULAR_TAGS = {{ popular_tags | tojson | safe }};
const INITIAL_CTR = {{ ctr_result if ctr_result else 'null' }};
const INITIAL_CONF = {{ confidence if confidence else 0 }};
const INITIAL_CONF_LEVEL = "{{ confidence_level if confidence_level else '' }}";

/* ---------- DOM Helpers ---------- */
function qs(sel) { return document.querySelector(sel); }
function qsa(sel) { return document.querySelectorAll(sel); }

/* ---------- Animated counters (uses GSAP) ---------- */
function animateCounter(el, endValue, suffix="") {
  el = (typeof el === 'string') ? qs(el) : el;
  if (!el) return;
  const start = parseFloat(el.innerText.replace(/[^0-9.-]/g,'')) || 0;
  gsap.to({v: start}, {
    duration: 1.2,
    v: endValue,
    ease: "power2.out",
    onUpdate() { el.innerText = Math.round(this.targets()[0].v) + suffix; }
  });
}

/* ---------- Charts setup (Chart.js) ---------- */
let viewsEngagementChart = null;
let probChart = null;
let gaugeChart = null;

function createViewsEngagementChart() {
  const labels = TOP_VIDEOS.map((v,i)=> (v.title && v.title.length>30) ? ('V'+(i+1)) : `V${i+1}`);
  const views = TOP_VIDEOS.map(v=> v.views || 0);
  const viewsPerDay = TOP_VIDEOS.map(v=> v.views_per_day || 0);
  const likes = TOP_VIDEOS.map(v=> v.likes || 0);

  const ctx = document.getElementById('viewsEngagement').getContext('2d');
  if (viewsEngagementChart) viewsEngagementChart.destroy();
  viewsEngagementChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Views', data: views, backgroundColor:'rgba(6,182,212,0.14)', borderColor: 'rgba(6,182,212,0.85)', borderWidth:1, yAxisID:'y' },
        { label: 'Views/Day', data: viewsPerDay, type:'line', tension:0.35, borderColor: 'rgba(99,102,241,0.95)', fill:false, yAxisID:'y2' },
        { label: 'Likes', data: likes, backgroundColor:'rgba(124,58,237,0.12)', borderColor: 'rgba(124,58,237,0.9)', borderWidth:1, yAxisID:'y' }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect:false },
      scales: {
        x: { ticks: { color: '#94a3b8' } },
        y: { position:'left', ticks:{ color:'#94a3b8' } },
        y2: { position:'right', grid:{ display:false }, ticks:{ color:'#94a3b8' } }
      },
      plugins: {
        legend: { labels:{ color:'#cbd5f5' } },
        tooltip: { mode:'index', intersect:false }
      }
    }
  });
}

function createProbChart() {
  const ctx = document.getElementById('probChart')?.getContext('2d');
  // small compatibility: if not present skip
  if (!ctx) return;
  if (probChart) probChart.destroy();
  probChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Trending Probability'],
      datasets: [{ data: [INITIAL_CONF || 0], backgroundColor: ['rgba(6,182,212,0.9)'] }]
    },
    options: { indexAxis:'y', scales:{ x:{ min:0, max:100 }, y:{ ticks:{ color:'#94a3b8' } } }, plugins:{ legend:{ display:false } } }
  });
}

/* Gauge implemented as doughnut with gradient ring */
function createGauge() {
  const ctx = document.getElementById('gaugeChart').getContext('2d');
  if (gaugeChart) gaugeChart.destroy();

  const val = INITIAL_CONF || 0;
  gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['value', 'remaining'],
      datasets: [{
        data: [val, 100-val],
        backgroundColor: [
          getGradient(ctx, '#06b6d4', '#7c3aed'),
          'rgba(255,255,255,0.06)'
        ],
        hoverOffset: 4,
        cutout: '78%'
      }]
    },
    options: {
      responsive:true,
      rotation: -110 * Math.PI/180,
      circumference: 220 * Math.PI/180,
      plugins: { legend:{ display:false }, tooltip:{ enabled:false } }
    }
  });
  // place numeric in center
  placeGaugeLabel(val);
}

function getGradient(ctx, a, b) {
  const grad = ctx.createLinearGradient(0,0,400,0);
  grad.addColorStop(0, a);
  grad.addColorStop(1, b);
  return grad;
}

function placeGaugeLabel(val) {
  // create overlay element
  const parent = qs('#gaugeChart').parentElement;
  let overlay = parent.querySelector('.gauge-value');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'gauge-value absolute inset-0 flex items-center justify-center pointer-events-none';
    overlay.style.top = '0';
    overlay.style.left = '0';
    parent.style.position = 'relative';
    parent.appendChild(overlay);
  }
  overlay.innerHTML = `<div class="text-center"><div class="text-3xl font-bold">${Math.round(val)}%</div><div class="small muted">Confidence</div></div>`;
}

/* ---------- UI interactions ---------- */

function setupSliders() {
  const vs = qs('#viewsSlider'), ev = qs('#engSlider');
  const vval = qs('#viewsVal'), evalEl = qs('#engVal');
  if (vs) vs.addEventListener('input', (e)=> vval.innerText = parseInt(e.target.value).toLocaleString());
  if (ev) ev.addEventListener('input', (e)=> evalEl.innerText = parseFloat(e.target.value).toFixed(3));
}

function setupButtons() {
  qs('#resetFilters')?.addEventListener('click', ()=> {
    qs('select[name="region"]').value = '';
    qs('select[name="category"]').value = '';
  });

  qs('#demoBtn')?.addEventListener('click', ()=> {
    // quick fake demo to show prediction result UI
    const resultBox = qs('#predictionResult');
    resultBox.classList.remove('hidden');
    const ctrEl = qs('#predCTR');
    const confEl = qs('#predConf');
    const progress = qs('#predProgress');
    // demo random
    const ctr = (Math.random()*15+1).toFixed(1);
    const conf = Math.round(Math.random()*90+5);
    ctrEl.innerText = ctr + '%';
    confEl.innerText = conf + '%';
    progress.style.width = conf + '%';
    qs('#predExplain').innerText = 'Title length and publish hour are contributing positively.';
    gsap.fromTo(progress, {width:'0%'}, {width: conf + '%', duration:1.1, ease:'power2.out'});
    animateCounter(ctrEl, Math.round(parseFloat(ctr)));
  });

  qs('#exportBtn')?.addEventListener('click', ()=> {
    // open modal
    qs('#modal').classList.add('show');
  });
  qs('#closeModal')?.addEventListener('click', ()=> qs('#modal').classList.remove('show'));
  qs('#downloadCSV')?.addEventListener('click', downloadCSVReport);
  qs('#downloadPNG')?.addEventListener('click', downloadChartPNG);

  qs('#refreshBtn')?.addEventListener('click', ()=> {
    // simple refresh animation
    gsap.fromTo('.glass', {opacity:0.6}, {opacity:1, duration:0.6, stagger:0.02});
    // rebuild charts to simulate refresh
    createViewsEngagementChart(); createGauge(); createProbChart();
  });

  qs('#toggleCompact')?.addEventListener('click', ()=> {
    document.querySelectorAll('.table-card table').forEach(t=> t.classList.toggle('text-sm'));
  });

  qs('#downloadReport')?.addEventListener('click', ()=> {
    // quick CSV export of top_videos
    downloadCSVReport();
  });

  // theme toggle: simple light/dark inversion for demo
  qs('#themeToggle')?.addEventListener('click', ()=> {
    if (document.documentElement.style.getPropertyValue('--bg-900') === '#0f1724') {
      // switch to lightish
      document.documentElement.style.setProperty('--bg-900', '#f8fafc');
      document.documentElement.style.setProperty('--text', '#0b1220');
      document.body.style.background = 'linear-gradient(180deg,#fff,#f7fafc)';
    } else {
      document.documentElement.style.setProperty('--bg-900', '#0f1724');
      document.documentElement.style.setProperty('--text', '#e6eef8');
      document.body.style.background = 'linear-gradient(180deg,var(--bg-900), #03040a 120%)';
    }
    gsap.fromTo('main',{opacity:.8},{opacity:1,duration:.6});
  });
}

/* ---------- Export & utility functions ---------- */
function downloadCSVReport() {
  const rows = TOP_VIDEOS.map(v => ({
    title: v.title,
    views: v.views,
    views_per_day: v.views_per_day,
    likes: v.likes,
    engagement: v.engagement_rate || ''
  }));
  const header = Object.keys(rows[0]||{});
  const csv = [header.join(',')].concat(rows.map(r=> header.map(h=> `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  saveAs(blob, 'top_videos_report.csv');
}

/* download chart PNG snapshot */
function downloadChartPNG() {
  const c = document.getElementById('viewsEngagement');
  if (!c) return;
  c.toBlob(function(blob) {
    saveAs(blob, 'views_engagement.png');
  });
}

/* ---------- Initial render ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // build charts
  createViewsEngagementChart();
  createGauge();
  createProbChart();
  // animate KPI counters (if values available)
  if (INITIAL_CTR !== null && INITIAL_CTR !== undefined) {
    const el = qs('.counter');
    // try animate the numeric CTR (first .counter found)
    const elCtr = qsa('.counter')[0];
    if (elCtr) animateCounter(elCtr, Math.round(INITIAL_CTR));
  }
  setupSliders();
  setupButtons();

  // subtle entrance animation
  gsap.fromTo('main > *', {y:10, opacity:0}, {y:0, opacity:1, stagger:0.05, duration:0.6, ease:'power2.out'});
});

/* ---------- safety: responsive redraw ---------- */
window.addEventListener('resize', ()=> {
  try { viewsEngagementChart?.resize(); probChart?.resize(); gaugeChart?.resize(); } catch(e){}
});

/* =======================================================
   THEME ENGINE â€” SAFE ADDON (NO EXISTING CODE TOUCHED)
   ======================================================= */

/* ---------- THEME LIST ---------- */
const THEMES = ["material","neon","slate","light","oled"];

/* ---------- LOAD SAVED THEME ---------- */
(function initTheme(){
  const saved = localStorage.getItem("ui-theme");
  if(saved && THEMES.includes(saved)){
    document.documentElement.setAttribute("data-theme", saved);
  } else {
    document.documentElement.setAttribute("data-theme","material");
  }
})();

/* ---------- THEME TOGGLE (CYCLE) ---------- */
const themeBtn = document.getElementById("themeToggle");
if(themeBtn){
  themeBtn.addEventListener("click", ()=>{
    const current = document.documentElement.getAttribute("data-theme") || "material";
    const idx = THEMES.indexOf(current);
    const next = THEMES[(idx+1) % THEMES.length];
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("ui-theme", next);

    /* micro feedback */
    gsap.fromTo(
      "body",
      {opacity:0.85},
      {opacity:1, duration:0.35, ease:"power2.out"}
    );
  });
}

/* =======================================================
   RESPONSIVE + SAFETY PATCHES
   ======================================================= */

/* ---------- FIX: charts on resize ---------- */
window.addEventListener("resize", ()=>{
  try{
    viewsEngagementChart?.resize();
    gaugeChart?.resize();
    probChart?.resize();
  }catch(e){}
});

/* ---------- FIX: mobile table overflow ---------- */
(function responsiveTables(){
  document.querySelectorAll("table").forEach(t=>{
    t.parentElement.style.overflowX = "auto";
    t.style.minWidth = "640px";
  });
})();

/* ---------- FIX: sidebar collapse on small screens ---------- */
(function mobileSidebar(){
  const aside = document.querySelector("aside");
  if(!aside) return;

  function adapt(){
    if(window.innerWidth < 1024){
      aside.classList.add("order-last");
    }else{
      aside.classList.remove("order-last");
    }
  }
  adapt();
  window.addEventListener("resize", adapt);
})();

/* =======================================================
   UX POLISH (NO FEATURE REMOVAL)
   ======================================================= */

/* ---------- BUTTON RIPPLE ---------- */
document.querySelectorAll("button").forEach(btn=>{
  btn.addEventListener("click", e=>{
    const r = document.createElement("span");
    r.style.position="absolute";
    r.style.inset="0";
    r.style.background="radial-gradient(circle, rgba(255,255,255,.35) 10%, transparent 60%)";
    r.style.opacity="0.6";
    r.style.pointerEvents="none";
    r.style.animation="fadeRipple .6s ease-out";
    btn.style.position="relative";
    btn.appendChild(r);
    setTimeout(()=>r.remove(),600);
  });
});

/* ---------- RIPPLE KEYFRAME ---------- */
const rippleStyle = document.createElement("style");
rippleStyle.innerHTML = `
@keyframes fadeRipple{
  from{opacity:.6}
  to{opacity:0}
}`;
document.head.appendChild(rippleStyle);

/* =======================================================
   DEMO DATA SAFETY (PREVENT JS BREAK)
   ======================================================= */
if(!window.TOP_VIDEOS) window.TOP_VIDEOS = [];
if(!window.COMPETITORS) window.COMPETITORS = [];
if(!window.POPULAR_TAGS) window.POPULAR_TAGS = [];

/* =======================================================
   DEBUG HELP (TEMP â€” CAN REMOVE LATER)
   ======================================================= */
console.log("âœ… Theme Engine Loaded");
console.log("ðŸŽ¨ Current Theme:", document.documentElement.getAttribute("data-theme"));
/* =========================================================
   THEME ENGINE â€“ JS ADDON (SAFE, NON-DESTRUCTIVE)
   ========================================================= */

(function () {
  const THEMES = ["material", "neon", "slate", "light", "oled"];
  const root = document.documentElement;
  const btn = document.getElementById("themeToggle");

  // ---------- LOAD SAVED THEME ----------
  const savedTheme = localStorage.getItem("ui-theme");
  if (savedTheme && THEMES.includes(savedTheme)) {
    root.setAttribute("data-theme", savedTheme);
  } else {
    root.setAttribute("data-theme", "material");
  }

  // ---------- THEME SWITCH ----------
  function cycleTheme() {
    const current = root.getAttribute("data-theme") || "material";
    const idx = THEMES.indexOf(current);
    const next = THEMES[(idx + 1) % THEMES.length];

    root.setAttribute("data-theme", next);
    localStorage.setItem("ui-theme", next);

    // subtle animation
    if (window.gsap) {
      gsap.fromTo(
        "body",
        { opacity: 0.85 },
        { opacity: 1, duration: 0.35, ease: "power1.out" }
      );
    }
  }

  if (btn) {
    btn.addEventListener("click", cycleTheme);
  }

  // ---------- RESPONSIVE FIXES ----------
  function responsiveFix() {
    const isMobile = window.innerWidth < 1024;

    // tables scroll fix
    document.querySelectorAll(".table-card").forEach((el) => {
      el.style.overflowX = isMobile ? "auto" : "visible";
    });

    // sidebar spacing
    document.querySelectorAll("aside").forEach((el) => {
      el.style.position = isMobile ? "static" : "relative";
    });
  }

  window.addEventListener("resize", responsiveFix);
  responsiveFix();

  // ---------- SAFE GUARD ----------
  console.log("âœ… Theme engine loaded | Responsive fixes active");
})();
/* =========================================================
   RESPONSIVE ENGINE â€“ SIDEBAR + CARD AUTO STACK
   ========================================================= */

(function () {

  /* ---------- ELEMENT CACHE ---------- */
  const main = document.querySelector("main");
  const sidebar = document.querySelector("aside");
  const themeBtn = document.getElementById("themeToggle");

  /* ---------- MOBILE DETECTION ---------- */
  function isMobile() {
    return window.innerWidth < 1024;
  }

  /* ---------- SIDEBAR COLLAPSE ---------- */
  function applySidebarBehavior() {
    if (!sidebar) return;

    if (isMobile()) {
      sidebar.classList.add("mobile-sidebar");
      sidebar.style.width = "100%";
      sidebar.style.marginBottom = "1.5rem";
    } else {
      sidebar.classList.remove("mobile-sidebar");
      sidebar.style.width = "";
      sidebar.style.marginBottom = "";
    }
  }

  /* ---------- CARD AUTO STACK ---------- */
  function autoStackCards() {
    document.querySelectorAll(".glass").forEach(card => {
      if (isMobile()) {
        card.style.marginBottom = "1rem";
      } else {
        card.style.marginBottom = "";
      }
    });
  }

  /* ---------- KPI GRID FIX ---------- */
  function fixKPIGrid() {
    document.querySelectorAll(".grid").forEach(grid => {
      if (isMobile()) {
        grid.style.gridTemplateColumns = "1fr";
      } else {
        grid.style.gridTemplateColumns = "";
      }
    });
  }

  /* ---------- SMOOTH SCROLL FIX ---------- */
  function enableSmoothScroll() {
    document.documentElement.style.scrollBehavior = "smooth";
  }

  /* ---------- SAFE INIT ---------- */
  function initResponsive() {
    applySidebarBehavior();
    autoStackCards();
    fixKPIGrid();
    enableSmoothScroll();
  }

  /* ---------- EVENT LISTENERS ---------- */
  window.addEventListener("resize", () => {
    initResponsive();
  });

  document.addEventListener("DOMContentLoaded", () => {
    initResponsive();

    // GSAP entrance for mobile
    if (window.gsap && isMobile()) {
      gsap.from("aside .glass", {
        opacity: 0,
        y: 20,
        duration: 0.4,
        stagger: 0.08,
        ease: "power2.out"
      });
    }
  });

  /* ---------- DEBUG ---------- */
  console.log("âœ… Responsive engine active | Sidebar + cards optimized");

})();
/* =========================================================
   SMART CHART ENGINE â€“ AUTO RESIZE + VISIBILITY FIX
   ========================================================= */

(function () {

  /* ---------- SAFE CHART REGISTRY ---------- */
  const chartRegistry = [];

  function registerChart(chartInstance) {
    if (chartInstance && !chartRegistry.includes(chartInstance)) {
      chartRegistry.push(chartInstance);
    }
  }

  /* ---------- REGISTER EXISTING CHARTS ---------- */
  if (typeof viewsEngagementChart !== "undefined") {
    registerChart(viewsEngagementChart);
  }
  if (typeof gaugeChart !== "undefined") {
    registerChart(gaugeChart);
  }
  if (typeof probChart !== "undefined") {
    registerChart(probChart);
  }

  /* ---------- FORCE RESIZE ---------- */
  function resizeCharts() {
    chartRegistry.forEach(chart => {
      try {
        chart.resize();
        chart.update("none");
      } catch (e) {}
    });
  }

  /* ---------- VISIBILITY OBSERVER ---------- */
  function observeChartVisibility() {
    const canvases = document.querySelectorAll("canvas");

    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          resizeCharts();
        }
      });
    }, { threshold: 0.25 });

    canvases.forEach(c => observer.observe(c));
  }

  /* ---------- MOBILE DPI FIX ---------- */
  function fixCanvasDPI() {
    document.querySelectorAll("canvas").forEach(canvas => {
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
    });
  }

  /* ---------- TAB / WINDOW RESUME FIX ---------- */
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      resizeCharts();
    }
  });

  window.addEventListener("resize", () => {
    fixCanvasDPI();
    resizeCharts();
  });

  /* ---------- INIT ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    fixCanvasDPI();
    observeChartVisibility();
    resizeCharts();
  });

  /* ---------- DEBUG ---------- */
  console.log("ðŸ“Š Chart engine active | Auto resize + visibility handled");

})();
/* =========================================================
   SMART CONFIDENCE HEAT + AI INSIGHT ENGINE
   ========================================================= */

(function () {

  function getConfidenceLevel(conf) {
    if (conf < 40) return "low";
    if (conf < 70) return "medium";
    return "high";
  }

  function applyConfidenceHeat(conf) {
    const box = document.getElementById("explainBox");
    if (!box) return;

    box.classList.remove("border-red-500/40", "border-yellow-400/40", "border-emerald-400/40");

    if (conf < 40) {
      box.classList.add("border", "border-red-500/40");
    } else if (conf < 70) {
      box.classList.add("border", "border-yellow-400/40");
    } else {
      box.classList.add("border", "border-emerald-400/40");
    }
  }

  function generateAIInsights(conf) {
    const insights = [];

    if (conf < 40) {
      insights.push("âš ï¸ Low trending confidence detected.");
      insights.push("âŒ Current publish timing may not be optimal.");
      insights.push("ðŸ’¡ Improve title clarity and add trending keywords.");
      insights.push("ðŸ“‰ Expected early engagement is weak.");
    }

    else if (conf < 70) {
      insights.push("ðŸŸ¡ Moderate trending potential.");
      insights.push("âœ… Title length is acceptable.");
      insights.push("ðŸ’¡ Publishing during peak hours can boost CTR.");
      insights.push("ðŸ“ˆ Engagement may improve with better tags.");
    }

    else {
      insights.push("ðŸŸ¢ High trending probability!");
      insights.push("ðŸš€ Strong early engagement expected.");
      insights.push("ðŸ”¥ Title & timing are well optimized.");
      insights.push("ðŸ“Š Video has strong discovery potential.");
    }

    return insights;
  }

  function renderAIInsights(conf) {
    const box = document.getElementById("explainBox");
    if (!box) return;

    const insights = generateAIInsights(conf);

    box.innerHTML = `
      <ul class="list-disc ml-4 space-y-1">
        ${insights.map(i => `<li>${i}</li>`).join("")}
      </ul>
    `;
  }

  /* ---------- INIT ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    const conf = Number(INITIAL_CONF || 0);

    if (!conf) return;

    applyConfidenceHeat(conf);
    renderAIInsights(conf);

    console.log("ðŸ§  AI Insight engine active | confidence =", conf);
  });

})();


</script>

</body>
</html>
